#!/bin/sh
# Copyright (C) GAMS Development 2008
# All Rights Reserved.
# This file is distributed under the Common Public License.
#
## $Id$
#
# Author: Stefan Vigerske

srcdir="@srcdir@"
gamspath="@GAMS_PATH@"

if test x$gamspath = xUNAVAILABLE; then
  echo "No GAMS system available."
  echo "Please download demo system from www.gams.com, rerun configure, install the solvers, and try again."
  exit 1
else
  echo "Using GAMS system at " $gamspath
fi

#echo " "
echo Getting quality tests driver from GAMS test library...
$gamspath/testlib quality

if test ! -e quality.gms ; then
  echo "Failed to obtain quality.gms from GAMS test library."
  exit 1
fi

solvers=
skiplist=
declare -a testlist
if test @gamslinks_build_ipopt@ = 1 ; then
  solvers="$solvers , Ipopt"
  skiplist="$skiplist skip('Ipopt','lp03')=yes;"
  skiplist="$skiplist skip('Ipopt','sl4lp03')=yes;"
  skiplist="$skiplist skip('Ipopt','lp10')=yes;"
  skiplist="$skiplist skip('Ipopt','sl4lp10')=yes;"
  testlist[${#testlist[@]}]="--solver ipopt --suite lp"
  testlist[${#testlist[@]}]="--solver ipopt --suite nlp"
  testlist[${#testlist[@]}]="--solver ipopt --suite qcp"
fi
if test @gamslinks_build_glpk@ = 1 ; then
  solvers="$solvers , Glpk"
  skiplist="$skiplist skip('Glpk','sos1a')=yes;"
  skiplist="$skiplist skip('Glpk','sl4sos1a')=yes;"
  skiplist="$skiplist skip('Glpk','semicon1')=yes;"
  skiplist="$skiplist skip('Glpk','sl4scon1')=yes;"
  testlist[${#testlist[@]}]="--solver glpk --suite lp"
  testlist[${#testlist[@]}]="--solver glpk --suite mip user1=rmip=glpk"
fi
if test @gamslinks_build_cbc@ = 1 ; then
  solvers="$solvers , Cbc"
  skiplist="$skiplist skip('Cbc','semicon1')=yes;"
  skiplist="$skiplist skip('Cbc','sl4scon1')=yes;"
  testlist[${#testlist[@]}]="--solver cbc --suite lp"
  testlist[${#testlist[@]}]="--solver cbc --suite mip user1=rmip=cbc"
fi
if test @gamslinks_build_bonmin@ = 1 ; then
  solvers="$solvers , Bonmin"
  skiplist="$skiplist skip('Bonmin','sos1a')=yes;"
  skiplist="$skiplist skip('Bonmin','sl4sos1a')=yes;"
  skiplist="$skiplist skip('Bonmin','semicon1')=yes;"
  skiplist="$skiplist skip('Bonmin','sl4scon1')=yes;"
  skiplist="$skiplist skip('Bonmin','lp03')=yes;"
  skiplist="$skiplist skip('Bonmin','sl4lp03')=yes;"
  skiplist="$skiplist skip('Bonmin','lp10')=yes;"
  skiplist="$skiplist skip('Bonmin','sl4lp10')=yes;"
  testlist[${#testlist[@]}]="--solver bonmin --suite lp"
  testlist[${#testlist[@]}]="--solver bonmin --suite mip user1=rmip=bonmin"
  testlist[${#testlist[@]}]="--solver bonmin --suite nlp"
  testlist[${#testlist[@]}]="--solver bonmin --suite qcp"
fi

echo "Patch quality test driver to get COIN solvers and skip list in." 
#we add our solvers to the list of master solvers and put our skiplist somewhere (in front of skip('convert',mdl)=yes)
sed -e "/master set of solvers/s/\/;\$/$solvers \/;/" \
    -e "/^skip('convert'/s/^/$skiplist /" \
    quality.gms > quality_coin.gms
echo ""

#remove all log or failure files
rm -f quality_test_*.log failures_qa*.gms

#indicates whether there was a failed test, also return code of this script
testfailed=0

for (( i=0 ; i<${#testlist[@]} ; i++ )) ; do
  echo "Run quality test $(($i+1)) of ${#testlist[@]} with options " ${testlist[$i]} 

	if $gamspath/gams quality_coin.gms ${testlist[$i]} --DEMOSIZE=1 lo=2 logfile=quality_test_$i.log ; then
		echo "Test " ${testlist[$i]} " passed."
	else
		testfailed=1
		mv failures_qa.gms failures_qa_$i.gms    
		echo "Test " ${testlist[$i]} " failed. Content of failures_qa_$i.gms:"
		cat failures_qa_$i.gms
	fi
	echo ""
	
done

exit $testfailed
