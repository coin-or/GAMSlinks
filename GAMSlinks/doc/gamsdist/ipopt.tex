\chapter{\IPOPT and \IPOPTH}
\label{cha:ipopt}

%\minitoc

COIN-OR \IPOPT (\textbf{I}nterior \textbf{P}oint \textbf{Opt}imizer) is an open-source solver for large-scale nonlinear programming.
The code has been written primarily by Andreas W\"achter, who is the COIN-OR project leader for \IPOPT.

\IPOPT implements an interior point line search filter method for nonlinear programming models which functions can be nonconvex, but should be twice continuously differentiable.
For more information on the algorithm we refer to~\cite{NoWaWa08,Waechter2002,WaBi05b,WaBi05a,WaBi2006} and the \IPOPT web site \url{https://projects.coin-or.org/Ipopt}.
Most of the \IPOPT documentation in the section was taken from the \IPOPT manual~\cite{IpoptManual}.



\section{The linear solver in \IPOPT}
\label{sec:ipoptlinearsolver}
\hypertarget{ipoptlinearsolver}{}

The performance and robustness of \IPOPT on larger models heavily relies on the used solver for sparse symmetric indefinite linear systems.

\GAMS/\IPOPT includes the sparse solver \textsc{MUMPS}~\cite{AmestoyDuffKosterLExcellent2001,AmestoyGuermoucheLExcellentPralet2006} (currently the default), cf.~\url{http://graal.ens-lyon.fr/MUMPS} and \textsc{MKL PARDISO}~\cite{SchGa04,SchGa06} (only Linux and Windows).
In the commerically licensed \GAMS/\IPOPTH version, also the Harwell Subroutine Library (HSL) solvers \textsc{MA27}, \textsc{MA57}, \textsc{HSL\_MA86}, and \textsc{HSL\_MA97} are available and MA27 is used by default.

\textsc{MUMPS}, \textsc{MA57}, \textsc{HSL\_MA86}, and \textsc{HSL\_MA97} use \textsc{METIS} for matrix ordering \cite{KaKu99}, cf.~\url{http://glaros.dtc.umn.edu/gkhome/views/metis/index.html} and \url{http://glaros.dtc.umn.edu/gkhome/fetch/sw/metis/manual.pdf}.
\textsc{METIS} is copyrighted by the regents of the University of Minnesota.

\IPOPT and \IPOPTH can exploit parallelization of the linear solver or the linear algebra routines (Blas and Lapack).
The following table summarizes which options are available on which platform.

\begin{tabular}{l|c|cc|cccc}
& \multicolumn{3}{c|}{\IPOPT and \IPOPTH} & \multicolumn{4}{c}{\IPOPTH only} \\
        & Linear Algebra & MUMPS & MKL PARDISO & MA27 & MA57 & HSL MA86 & HSL MA97 \\ \hline
Linux   & parallel & serial & parallel      & serial & serial & parallel & parallel \\
MacOS X & parallel & serial & not available & serial & serial & parallel & parallel  \\
Solaris & serial   & serial & not available & serial & serial & parallel & parallel  \\
Windows & parallel & serial & parallel      & serial & serial & parallel & parallel  \\
\end{tabular}

The linear solver is chosen by the \texttt{linear\_solver} option.
Benchmarks have shown that \textsc{MA57} and \textsc{HSL\_MA97} are often able to outperform \textsc{MA27} on larger instances. Further, \textsc{PARDISO} often allows for performance that is better than \textsc{MUMPS} and similar to the HSL solvers. If \IPOPT fails to solve an instance with \textsc{PARDISO}, it's worth to try changing the options \texttt{pardiso\_order} and \texttt{pardiso\_max\_iterative\_refinement\_steps}.

\section{Usage}

The following statement can be used inside your \GAMS program to specify using \IPOPT
\begin{verbatim}
  Option NLP = IPOPT;     { or LP, RMIP, DNLP, RMINLP, QCP, RMIQCP }
\end{verbatim}

The above statement should appear before the Solve statement.
If \IPOPT was specified as the default solver during \GAMS installation, the above statement is not necessary.

To use \IPOPTH, the statement should be
\begin{verbatim}
  Option NLP = IPOPTH;    { or LP, RMIP, DNLP, RMINLP, QCP, RMIQCP }
\end{verbatim}



\paragraph{Using Harwell Subroutine Library routines with \GAMS/\IPOPT.}

\GAMS/\IPOPT can use the HSL routines \texttt{MA27}, \texttt{MA28}, \texttt{MA57}, \textsc{HSL\_MA77}, \textsc{HSL\_MA86}, \textsc{HSL\_MA97}, \texttt{MC19}, and \textsc{HSL\_MC68} when provided as shared library.
By telling \IPOPT to use one of these routines (see options \texttt{linear\_solver}, \texttt{linear\_system\_scaling}, \texttt{nlp\_scaling\_method}, \texttt{dependency\_detector}), \GAMS/\IPOPT attempts to load the required routines from the library \texttt{libhsl.so} (Unix-Systems), \texttt{libhsl.dylib} (MacOS X), or \texttt{libhsl.dll} (Windows), respectively.

The HSL routines are available at \url{http://www.hsl.rl.ac.uk/ipopt}.
Note that it is your responsibility to ensure that you are entitled to download and use these routines!
% You can build a shared library using the ThirdParty/HSL project at COIN-OR.

\paragraph{Using PARDISO with \GAMS/\IPOPT or \GAMS/\IPOPTH.}
On Mac OS X and Solaris, setting the option \texttt{linear\_solver} to \texttt{pardiso} lets \GAMS/\IPOPT or \GAMS/\IPOPTH try to load the linear solver PARDISO from the library \texttt{libpardiso.so} (Unix) or \texttt{libpardiso.dylib} (MacOS X), respectively.

PARDISO is available as compiled shared library for several platforms at \texttt{http://www.pardiso-project.org}.
Note that it is your responsibility to ensure that you are entitled to download and use this package!

\subsection{Specification of Options}
\label{sub:ipoptoptionspec}

\IPOPT has many options that can be adjusted for the algorithm (see Section \ref{sub:ipoptoptions}).
Options are all identified by a string name, and their values can be of one of three types: Number (real), Integer, or String.
Number options are used for things like tolerances, integer options are used for things like maximum number of iterations, and string options are used for setting algorithm details, like the NLP scaling method.
Options can be set by creating a \texttt{ipopt.opt} file in the directory you are executing \IPOPT.

The \texttt{ipopt.opt} file is read line by line and each line should contain the option name, followed by whitespace, and then the value.
Comments can be included with the \# symbol. Don't forget to ensure you have a newline at the end of the file. For example,
\begin{verbatim}
# This is a comment

# Turn off the NLP scaling
nlp_scaling_method none

# Change the initial barrier parameter
mu_init 1e-2

# Set the max number of iterations
max_iter 500
\end{verbatim}
is a valid \texttt{ipopt.opt} file.

% You can print the documentation for all \IPOPT options by using the option
% \begin{verbatim}
% print_options_documentation yes
% \end{verbatim}
% and running \IPOPT.
% This will output all of the options documentation to the console.

\GAMS/\IPOPT understand currently the following \GAMS parameters: \texttt{reslim} (time limit), \texttt{iterlim} (iteration limit), \texttt{domlim} (domain violation limit).
You can set them either on the command line, e.g. \verb+iterlim=500+, or inside your \GAMS program, e.g. \verb+Option iterlim=500;+.
Further the option \texttt{threads} can be used to control the number of threads used in the linear algebra routines and the linear solver, see also Section~\ref{sec:ipoptlinearsolver}.

\subsection{Warmstarting Ipopt}

As an interior point solver, it is difficult to warm start \IPOPT.
By default, only the level values of the variables are passed as starting point to \IPOPT.
Setting the \IPOPT option \texttt{warm\_start\_init\_point} to \texttt{yes} enables that also dual values for variables and constraints are passed to \IPOPT.

However, the expected behavior that \IPOPT finishes within one iteration if optimal primal and dual values are passed is not reached this way, yet. This is, because \IPOPT by default moves any initial value that is close to a bound into the interior. The amount on how much the initial point is moved can be controlled by various \texttt{bound\_push} and \texttt{bound\_frac} options.
To make \IPOPT accept an optimal primal/dual solution within one iteration, it should be sufficient to set the following options:
\begin{verbatim}
  warm_start_init_point       yes
  warm_start_bound_push       1e-9
  warm_start_bound_frac       1e-9
  warm_start_slack_bound_frac 1e-9
  warm_start_slack_bound_push 1e-9
  warm_start_mult_bound_push  1e-9
\end{verbatim}

\section{Output}

This section describes the standard \IPOPT console output.
The output is designed to provide a quick summary of each iteration as \IPOPT solves the problem.

Before \IPOPT starts to solve the problem, it displays the problem statistics (number of nonzero-elements in the matrices, number of variables, etc.).
Note that if you have fixed variables (both upper and lower bounds are equal), \IPOPT may remove these variables from the problem internally and not include them in the problem statistics.

Following the problem statistics, \IPOPT will begin to solve the problem and you will see output resembling the following,
\begin{verbatim}
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  1.6109693e+01 1.12e+01 5.28e-01   0.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  1.8029749e+01 9.90e-01 6.62e+01   0.1 2.05e+00    -  2.14e-01 1.00e+00f  1
   2  1.8719906e+01 1.25e-02 9.04e+00  -2.2 5.94e-02   2.0 8.04e-01 1.00e+00h  1
\end{verbatim}
and the columns of output are defined as
\begin{description}
\item[iter]
The current iteration count.
This includes regular iterations and iterations while in restoration phase.
If the algorithm is in the restoration phase, the letter \texttt{r} will be appended to the iteration number.
\item[objective]
The unscaled objective value at the current point.
During the restoration phase, this value remains the unscaled objective value for the original problem.
\item[inf\_pr]
The unscaled constraint violation at the current point.
This quantity is the infinity-norm (max) of the (unscaled) constraint violation.
During the restoration phase, this value remains the constraint violation of the original problem at the current point.
The option ``\texttt{inf\_pr\_output}'' can be used to switch to the printing of a different quantity.
During the restoration phase, this value is the primal infeasibility of the original problem at the current point.
\item[inf\_du]
The scaled dual infeasibility at the current point.
This quantity measure the infinity-norm (max) of the internal dual infeasibility \cite[Eq.~(4a)]{WaBi2006}, including inequality constraints reformulated using slack variables and problem scaling.
During the restoration phase, this is the value of the dual infeasibility for the restoration phase problem.
\item[lg(mu)]
$\log_{10}$ of the value of the barrier parameter $\mu$.
\item[$\Vert d\Vert$]
The infinity norm (max) of the primal step (for the original variables $x$ and the internal slack variables $s$).
During the restoration phase, this value includes the values of additional variables, $p$ and $n$ \cite[Eq.~(10)]{WaBi2006}.
\item[lg(rg)]
$\log_{10}$ of the value of the regularization term for the Hessian of the Lagrangian in the augmented system ($\delta_w$ in \cite[Eq.~(26)]{WaBi2006}).
A dash (``\texttt{-}'') indicates that no regularization was done.
\item[alpha\_du]
The stepsize for the dual variables ($\alpha^z_k$ in \cite[Eq.~(14c)]{WaBi2006})..
\item[alpha\_pr]
The stepsize for the primal variables ($\alpha_k$ in \cite[Eq.~(14a)]{WaBi2006}).
The number is usually followed by a character for additional diagnostic information regarding the step acceptance criterion:
 \begin{list}{blub}{\itemsep0pt}
    \item[\texttt{f}] f-type iteration in the filter method w/o second order correction
    \item[\texttt{F}] f-type iteration in the filter method w/ second order correction
    \item[\texttt{h}] h-type iteration in the filter method w/o second order correction
    \item[\texttt{H}] h-type iteration in the filter method w/ second order correction
    \item[\texttt{k}] penalty value unchanged in merit function method w/o second order correction
    \item[\texttt{K}] penalty value unchanged in merit function method w/ second order correction
    \item[\texttt{n}] penalty value updated in merit function method w/o second order correction
    \item[\texttt{N}] penalty value updated in merit function method w/ second order correction
    \item[\texttt{R}] Restoration phase just started
    \item[\texttt{w}] in watchdog procedure
    \item[\texttt{s}] step accepted in soft restoration phase
    \item[\texttt{t}/\texttt{T}] tiny step accepted without line search
    \item[\texttt{r}] some previous iterate restored
 \end{list}
\item[ls]
The number of backtracking line search steps (does not include second-order correction steps).
\end{description}

Note that the step acceptance mechanisms in \IPOPT consider the
barrier objective function \cite[Eq.~(3a)]{WaBi2006} which is
usually different from the value reported in the \texttt{objective}
column.  Similarly, for the purposes of the step acceptance, the
constraint violation is measured for the internal problem formulation,
which includes slack variables for inequality constraints and
potentially scaling of the constraint functions.  This value, too, is
usually different from the value reported in \texttt{inf\_pr}.  As a
consequence, a new iterate might have worse values both for the
objective function and the constraint violation as reported in the
iteration output, seemingly contradicting globalization procedure.


When the algorithm terminates, \IPOPT will output a message to the screen.
The following is a list of the possible output messages and a brief description.

\begin{description}
\item[Optimal Solution Found.] ~

    This message indicates that \IPOPT found a (locally) optimal point within the desired tolerances.

\item[Solved To Acceptable Level.] ~

    This indicates that the algorithm did not converge to the ``desired'' tolerances, but that it was able to obtain a point satisfying the ``acceptable'' tolerance level as specified by \texttt{acceptable-*} options.
    This may happen if the desired tolerances are too small for the current problem.

\item[Feasible point for square problem found.] ~

    This message is printed if the problem is ``square'' (i.e., it has as many equality constraints as free variables) and \IPOPT found a feasible point.

\item[Converged to a point of local infeasibility. Problem may be infeasible.] ~

    The restoration phase converged to a point that is a minimizer for the constraint violation (in the $\ell_1$-norm), but is not feasible for the original problem.
    This indicates that the problem may be infeasible (or at least that the algorithm is stuck at a locally infeasible point).
    The returned point (the minimizer of the constraint violation) might help you to find which constraint is causing the problem.
    If you believe that the NLP is feasible, it might help to start the optimization from a different point.

\item[Search Direction is becoming Too Small.] ~

    This indicates that \IPOPT is calculating very small step sizes and making very little progress.
    This could happen if the problem has been solved to the best numerical accuracy possible given the current scaling.

\item[Iterates divering; problem might be unbounded.] ~

    This message is printed if the max-norm of the iterates becomes larger than the value of the option \texttt{diverging\_iterates\_tol}.
    This can happen if the problem is unbounded below and the iterates are diverging.

\item[Stopping optimization at current point as requested by user.] ~

    This message is printed if either the Ctrl+C was pressed or the domain violation limit is reached.

\item[Maximum Number of Iterations Exceeded.] ~

    This indicates that \IPOPT has exceeded the maximum number of iterations as specified by the \IPOPT option \texttt{max\_iter} or the GAMS option \texttt{iterlim}.

\item[Maximum CPU time exceeded.] ~

    This indicates that \IPOPT has exceeded the maximum number of seconds as specified by the \IPOPT option \texttt{max\_cpu\_time} or the GAMS option \texttt{reslim}.

\item[Restoration Failed!] ~

    This indicates that the restoration phase failed to find a feasible point that was acceptable to the filter line search for the original problem.
    This could happen if the problem is highly degenerate or does not satisfy the constraint qualification, or if an external function in \GAMS provides incorrect derivative information.

\item[Error in step computation (regularization becomes too large?)!] ~

    This messages is printed if \IPOPT is unable to compute a search direction, despite several attempts to modify the iteration matrix.
    Usually, the value of the regularization parameter then becomes too large.

\item[Problem has too few degrees of freedom.] ~

    This indicates that your problem, as specified, has too few degrees of freedom.
    This can happen if you have too many equality constraints, or if you fix too many variables (\IPOPT removes fixed variables).

\item[Not enough memory.] ~

    An error occurred while trying to allocate memory.
    The problem may be too large for your current memory and swap configuration.

\item[INTERNAL ERROR: Unknown SolverReturn value - Notify \IPOPT Authors.] ~

    An unknown internal error has occurred. Please notify the authors of the \GAMS/\IPOPT link or \IPOPT (refer to \url{https://projects.coin-or.org/GAMSlinks} or \url{https://projects.coin-or.org/Ipopt}).
\end{description}


\subsection{Diagnostic Tags for \IPOPT}

To print additional diagnostic tags for each iteration of \IPOPT, set
the options \texttt{print\_info\_string} to \texttt{yes}. With
this, a tag will appear at the end of an iteration line with the
following diagnostic meaning that are useful to flag difficulties for
a particular \IPOPT run.  The following is a list of possible strings:
\begin{list}{blub}{\itemsep0pt}
 \item[\texttt{!}] Tighten resto tolerance if only slightly infeasible \cite[Sec.~3.3]{WaBi2006}
 \item[\texttt{A}] Current iteration is acceptable (alternate termination)
 \item[\texttt{a}] Perturbation for PD Singularity can't be done, assume singular \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{C}] Second Order Correction taken \cite[Sec.~2.4]{WaBi2006}
 \item[\texttt{Dh}] Hessian degenerate based on multiple iterations \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{Dhj}] Hessian/Jacobian degenerate based on multiple iterations \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{Dj}] Jacobian degenerate based on multiple iterations \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{dx}] $\delta_x$ perturbation too large \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{e}] Cutting back $\alpha$ due to evaluation error (in backtracking line search)
 \item[\texttt{F-}] Filter should be reset, but maximal resets exceeded \cite[Sec.~2.3]{WaBi2006}
 \item[\texttt{F+}] Resetting filter due to last few rejections of filter \cite[Sec.~2.3]{WaBi2006}
 \item[\texttt{L}] Degenerate Jacobian, $\delta_c$ already perturbed \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{l}] Degenerate Jacobian, $\delta_c$ perturbed \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{M}] Magic step taken for slack variables (in backtracking line search)
 \item[\texttt{Nh}] Hessian not yet degenerate \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{Nhj}] Hessian/Jacobian not yet degenerate \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{Nj}] Jacobian not yet degenerate \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{NW}] Warm start initialization failed (in Warm Start Initialization)
 \item[\texttt{q}] PD system possibly singular, attempt to improve solution quality \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{R}] Solution of restoration phase \cite[Sec.~3.3]{WaBi2006}
 \item[\texttt{S}] PD system possibly singular, accept current solution \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{s}] PD system singular \cite[Sec.~3.1]{WaBi2006}
 \item[\texttt{s}] Square Problem. Set multipliers to zero (default initialization routine)
 \item[\texttt{Tmax}] Trial $\theta$ is larger than $\theta_{max}$ (filter parameter \cite[Eq.~(21)]{WaBi2006})
 \item[\texttt{W}] Watchdog line search procedure successful \cite[Sec.~3.2]{WaBi2006}
 \item[\texttt{w}] Watchdog line search procedure unsuccessful, stopped \cite[Sec.~3.2]{WaBi2006}
 \item[\texttt{Wb}] Undoing most recent SR1 update \cite[Sec.~5.4.1]{Biegler2010}
 \item[\texttt{We}] Skip Limited-Memory Update in restoration phase  \cite[Sec.~5.4.1]{Biegler2010}
 \item[\texttt{Wp}] Safeguard $B^0 = \sigma I$ for  Limited-Memory Update \cite[Sec.~5.4.1]{Biegler2010}
 \item[\texttt{Wr}] Resetting Limited-Memory Update \cite[Sec.~5.4.1]{Biegler2010}
 \item[\texttt{Ws}] Skip Limited-Memory Update since $s^Ty$ is not positive \cite[Sec.~5.4.1]{Biegler2010}
 \item[\texttt{WS}] Skip Limited-Memory Update since $\Delta x$ is too small \cite[Sec.~5.4.1]{Biegler2010}
 \item[\texttt{y}] Dual infeasibility, use least square multiplier update (during \IPOPT algorithm)
 \item[\texttt{z}] Apply correction to bound multiplier if too large (during \IPOPT algorithm)
\end{list}

\section{Detailed Options Description}
\label{sub:ipoptoptions}

% Note, that \GAMS/\IPOPT overwrites the \IPOPT default setting for the parameters \texttt{bound\_relax\_factor} (set to $10^{-10}$) and \texttt{mu\_strategy} (set to \texttt{adaptive}).
% You can change these values by specifying these options in your \IPOPT options file.

\input{optipopt_a}

\bibliographystyle{plain}
%\bibliography{coinlibd}
%\renewcommand{\bibname}{Ipopt References}
\input{ipopt.bbl}

\chapterend
