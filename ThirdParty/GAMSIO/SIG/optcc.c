/*  C code generated by apiwrapper */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include <ctype.h>
#include <errno.h>

#define OPT_MAIN
#include "optcc.h"

#if defined(_WIN32)
  static char winErr[] = "Windows error";
  typedef HINSTANCE soHandle_t;
#elif defined(CIA_HP7)
# include <unistd.h>
# include <dl.h>
  typedef shl_t soHandle_t;
#else
# include <unistd.h>
# include <dlfcn.h>
  typedef void *soHandle_t;
#endif

static soHandle_t h;
static int isLoaded = 0;
static int objectCount = 0;
static int ScreenIndicator = 1;
static int ExceptionIndicator = 0;
static int ExitIndicator = 0;
static optErrorCallback_t ErrorCallBack = NULL;
int optAPIErrorCount = 0;

typedef void (OPT_CALLCONV *XCreate_t) (optHandle_t *popt);
static OPT_FUNCPTR(XCreate);
typedef void (OPT_CALLCONV *XFree_t)   (optHandle_t *popt);
static OPT_FUNCPTR(XFree);
typedef int (OPT_CALLCONV *XAPIVersion_t) (int api, char *msg, int *cl);
static OPT_FUNCPTR(XAPIVersion);
typedef int (OPT_CALLCONV *XCheck_t) (const char *ep, int nargs, int s[], char *msg);
static OPT_FUNCPTR(XCheck);


typedef void (OPT_CALLCONV *optSetLoadPath_t) (const char *s);
OPT_FUNCPTR(optSetLoadPath);
typedef void (OPT_CALLCONV *optGetLoadPath_t) (char *s);
OPT_FUNCPTR(optGetLoadPath);

#define printNoReturn(f) { \
  optErrorHandling(#f " could not be loaded or has wrong signature!"); \
}
#define printAndReturn(f,rtype) { \
  optErrorHandling(#f " could not be loaded or has wrong signature!"); \
  return (rtype) 0; \
}

int  OPT_CALLCONV d_optReadDefinition (optHandle_t popt, const char *fn)
{ printAndReturn(optReadDefinition,int ) }

int  OPT_CALLCONV d_optReadParameterFile (optHandle_t popt, const char *fn)
{ printAndReturn(optReadParameterFile,int ) }

void  OPT_CALLCONV d_optReadFromStr (optHandle_t popt, const char *s)
{ printNoReturn(optReadFromStr) }

int  OPT_CALLCONV d_optWriteParameterFile (optHandle_t popt, const char *fn)
{ printAndReturn(optWriteParameterFile,int ) }

void  OPT_CALLCONV d_optClearMessages (optHandle_t popt)
{ printNoReturn(optClearMessages) }

void  OPT_CALLCONV d_optAddMessage (optHandle_t popt, const char *info)
{ printNoReturn(optAddMessage) }

void  OPT_CALLCONV d_optGetMessage (optHandle_t popt, int N, char *info, int *iType)
{ printNoReturn(optGetMessage) }

void  OPT_CALLCONV d_optResetAll (optHandle_t popt)
{ printNoReturn(optResetAll) }

void  OPT_CALLCONV d_optResetAllRecent (optHandle_t popt)
{ printNoReturn(optResetAllRecent) }

void  OPT_CALLCONV d_optResetRecentChanges (optHandle_t popt)
{ printNoReturn(optResetRecentChanges) }

void  OPT_CALLCONV d_optShowHelp (optHandle_t popt, const char *HlpID)
{ printNoReturn(optShowHelp) }

int  OPT_CALLCONV d_optResetNr (optHandle_t popt, int ANr)
{ printAndReturn(optResetNr,int ) }

int  OPT_CALLCONV d_optFindStr (optHandle_t popt, const char *AName, int *ANr, int *ARefNr)
{ printAndReturn(optFindStr,int ) }

int  OPT_CALLCONV d_optGetInfoNr (optHandle_t popt, int ANr, int *ADefined, int *ADefinedR, int *ARefNr, int *ADataType, int *AOptType, int *ASubType)
{ printAndReturn(optGetInfoNr,int ) }

int  OPT_CALLCONV d_optGetValuesNr (optHandle_t popt, int ANr, char *ASName, int *AIVal, double *ADVal, char *ASVal)
{ printAndReturn(optGetValuesNr,int ) }

int  OPT_CALLCONV d_optSetValuesNr (optHandle_t popt, int ANr, int AIVal, double ADVal, const char *ASVal)
{ printAndReturn(optSetValuesNr,int ) }

int  OPT_CALLCONV d_optSetValues2Nr (optHandle_t popt, int ANr, int AIVal, double ADVal, const char *ASVal)
{ printAndReturn(optSetValues2Nr,int ) }

void  OPT_CALLCONV d_optVersion (optHandle_t popt, char *sversion)
{ printNoReturn(optVersion) }

void  OPT_CALLCONV d_optDefinitionFile (optHandle_t popt, char *sfilename)
{ printNoReturn(optDefinitionFile) }

int  OPT_CALLCONV d_optGetFromAnyStrList (optHandle_t popt, int idash, char *skey, char *sval)
{ printAndReturn(optGetFromAnyStrList,int ) }

int  OPT_CALLCONV d_optGetFromListStr (optHandle_t popt, const char *skey, char *sval)
{ printAndReturn(optGetFromListStr,int ) }

int  OPT_CALLCONV d_optListCountStr (optHandle_t popt, const char *skey)
{ printAndReturn(optListCountStr,int ) }

int  OPT_CALLCONV d_optReadFromListStr (optHandle_t popt, const char *skey, int iPos, char *sval)
{ printAndReturn(optReadFromListStr,int ) }

int  OPT_CALLCONV d_optSynonymCount (optHandle_t popt)
{ printAndReturn(optSynonymCount,int ) }

int  OPT_CALLCONV d_optGetSynonym (optHandle_t popt, int N, char *SSyn, char *SName)
{ printAndReturn(optGetSynonym,int ) }

void  OPT_CALLCONV d_optEchoSet (optHandle_t popt, int V)
{ printNoReturn(optEchoSet) }

int  OPT_CALLCONV d_optEOLOnlySet (optHandle_t popt, int ival)
{ printAndReturn(optEOLOnlySet,int ) }

void  OPT_CALLCONV d_optNoBoundsSet (optHandle_t popt, int ival)
{ printNoReturn(optNoBoundsSet) }

void  OPT_CALLCONV d_optErrorCount (optHandle_t popt, int *iErrors, int *iWarnings)
{ printNoReturn(optErrorCount) }

int  OPT_CALLCONV d_optGetBoundsInt (optHandle_t popt, int ANr, int *ilval, int *ihval, int *idval)
{ printAndReturn(optGetBoundsInt,int ) }

int  OPT_CALLCONV d_optGetBoundsDbl (optHandle_t popt, int ANr, double *dlval, double *dhval, double *ddval)
{ printAndReturn(optGetBoundsDbl,int ) }

int  OPT_CALLCONV d_optGetDefaultStr (optHandle_t popt, int ANr, char *sval)
{ printAndReturn(optGetDefaultStr,int ) }

int  OPT_CALLCONV d_optGetIntNr (optHandle_t popt, int ANr, int *AIVal)
{ printAndReturn(optGetIntNr,int ) }

int  OPT_CALLCONV d_optGetInt2Nr (optHandle_t popt, int ANr, int *AIVal)
{ printAndReturn(optGetInt2Nr,int ) }

int  OPT_CALLCONV d_optSetIntNr (optHandle_t popt, int ANr, int AIVal)
{ printAndReturn(optSetIntNr,int ) }

int  OPT_CALLCONV d_optSetInt2Nr (optHandle_t popt, int ANr, int AIVal)
{ printAndReturn(optSetInt2Nr,int ) }

int  OPT_CALLCONV d_optGetStrNr (optHandle_t popt, int ANr, char *ASVal)
{ printAndReturn(optGetStrNr,int ) }

int  OPT_CALLCONV d_optGetOptHelpNr (optHandle_t popt, int ANr, char *AName, int *AHc, int *AGroup)
{ printAndReturn(optGetOptHelpNr,int ) }

int  OPT_CALLCONV d_optGetEnumHelp (optHandle_t popt, int ANr, int AOrd, int *AHc, char *AHelpStr)
{ printAndReturn(optGetEnumHelp,int ) }

int  OPT_CALLCONV d_optGetEnumStrNr (optHandle_t popt, int ANr, char *ASVal, int *AOrd)
{ printAndReturn(optGetEnumStrNr,int ) }

int  OPT_CALLCONV d_optGetEnumCount (optHandle_t popt, int ANr, int *ACount)
{ printAndReturn(optGetEnumCount,int ) }

int  OPT_CALLCONV d_optGetEnumValue (optHandle_t popt, int ANr, int AOrd, int *AValInt, char *AValStr)
{ printAndReturn(optGetEnumValue,int ) }

int  OPT_CALLCONV d_optGetStr2Nr (optHandle_t popt, int ANr, char *ASVal)
{ printAndReturn(optGetStr2Nr,int ) }

int  OPT_CALLCONV d_optSetStrNr (optHandle_t popt, int ANr, const char *ASVal)
{ printAndReturn(optSetStrNr,int ) }

int  OPT_CALLCONV d_optSetStr2Nr (optHandle_t popt, int ANr, const char *ASVal)
{ printAndReturn(optSetStr2Nr,int ) }

int  OPT_CALLCONV d_optGetDblNr (optHandle_t popt, int ANr, double *ADVal)
{ printAndReturn(optGetDblNr,int ) }

int  OPT_CALLCONV d_optGetDbl2Nr (optHandle_t popt, int ANr, double *ADVal)
{ printAndReturn(optGetDbl2Nr,int ) }

int  OPT_CALLCONV d_optSetDblNr (optHandle_t popt, int ANr, double ADVal)
{ printAndReturn(optSetDblNr,int ) }

int  OPT_CALLCONV d_optSetDbl2Nr (optHandle_t popt, int ANr, double ADVal)
{ printAndReturn(optSetDbl2Nr,int ) }

int  OPT_CALLCONV d_optGetValStr (optHandle_t popt, const char *AName, char *ASVal)
{ printAndReturn(optGetValStr,int ) }

int  OPT_CALLCONV d_optGetVal2Str (optHandle_t popt, const char *AName, char *ASVal)
{ printAndReturn(optGetVal2Str,int ) }

int  OPT_CALLCONV d_optGetNameNr (optHandle_t popt, int ANr, char *ASName)
{ printAndReturn(optGetNameNr,int ) }

int  OPT_CALLCONV d_optGetDefinedNr (optHandle_t popt, int ANr, int *AIVal)
{ printAndReturn(optGetDefinedNr,int ) }

int  OPT_CALLCONV d_optGetHelpNr (optHandle_t popt, int ANr, char *ASOpt, char *ASHelp)
{ printAndReturn(optGetHelpNr,int ) }

int  OPT_CALLCONV d_optGetGroupNr (optHandle_t popt, int ANr, char *AName, int *AGroup, int *AHc, char *AHelp)
{ printAndReturn(optGetGroupNr,int ) }

int  OPT_CALLCONV d_optGetGroupGrpNr (optHandle_t popt, int AGroup)
{ printAndReturn(optGetGroupGrpNr,int ) }

int  OPT_CALLCONV d_optGetOptGroupNr (optHandle_t popt, int ANr)
{ printAndReturn(optGetOptGroupNr,int ) }

int  OPT_CALLCONV d_optGetDotOptNr (optHandle_t popt, int ANr, char *AName, int *AObjNr, int *ADim, double *AValue)
{ printAndReturn(optGetDotOptNr,int ) }

int  OPT_CALLCONV d_optGetDotOptUel (optHandle_t popt, int ANr, int ADim, char *AUEL)
{ printAndReturn(optGetDotOptUel,int ) }

int  OPT_CALLCONV d_optGetIndicatorNr (optHandle_t popt, int ANr, char *EquName, char *VarName, int *EquDim, int *VarDim, int *AValue)
{ printAndReturn(optGetIndicatorNr,int ) }

int  OPT_CALLCONV d_optGetEquIndicatorNr (optHandle_t popt, int ANr, int ADim, char *AIndex)
{ printAndReturn(optGetEquIndicatorNr,int ) }

int  OPT_CALLCONV d_optGetVarIndicatorNr (optHandle_t popt, int ANr, int ADim, char *AIndex)
{ printAndReturn(optGetVarIndicatorNr,int ) }

int  OPT_CALLCONV d_optIndicatorCount (optHandle_t popt, int *ANrErrors)
{ printAndReturn(optIndicatorCount,int ) }

int  OPT_CALLCONV d_optDotOptCount (optHandle_t popt, int *ANrErrors)
{ printAndReturn(optDotOptCount,int ) }

int  OPT_CALLCONV d_optSetRefNr (optHandle_t popt, int ANr, int AValue)
{ printAndReturn(optSetRefNr,int ) }

int  OPT_CALLCONV d_optSetRefNrStr (optHandle_t popt, const char *AOpt, int AValue)
{ printAndReturn(optSetRefNrStr,int ) }

int  OPT_CALLCONV d_optGetConstName (optHandle_t popt, int cgroup, int cindex, char *cname)
{ printAndReturn(optGetConstName,int ) }

int  OPT_CALLCONV d_optGetTypeName (optHandle_t popt, int TNr, char *sTName)
{ printAndReturn(optGetTypeName,int ) }

int  OPT_CALLCONV d_optLookUp (optHandle_t popt, const char *AOpt)
{ printAndReturn(optLookUp,int ) }

void  OPT_CALLCONV d_optReadFromPChar (optHandle_t popt, char *p)
{ printNoReturn(optReadFromPChar) }

int  OPT_CALLCONV d_optCount (optHandle_t popt)
{ printAndReturn(optCount,int ) }

int  OPT_CALLCONV d_optMessageCount (optHandle_t popt)
{ printAndReturn(optMessageCount,int ) }

int  OPT_CALLCONV d_optGroupCount (optHandle_t popt)
{ printAndReturn(optGroupCount,int ) }

int  OPT_CALLCONV d_optRecentEnabled (optHandle_t popt)
{ printAndReturn(optRecentEnabled,int ) }

void OPT_CALLCONV d_optRecentEnabledSet (optHandle_t popt, int x)
{ printNoReturn(optRecentEnabled) }

/* return dirName on success, NULL on failure */
static char *
extractFileDirFileName (const char *fileName, char *dirName, char *fName)
{
  int fileNameLen, shave=0;
  const char *end, *s;
  char *t;

  if (NULL == fileName || NULL == dirName || fName == NULL) {
    return NULL;
  }
  fileNameLen = strlen(fileName);

#if defined(_WIN32)
  /* get the last delimiter */
  for (end = fileName + fileNameLen - 1;
       end >= fileName && '\\' != *end && ':' != *end;  end--);
  /* shave off the trailing delimiter if:
   *  it isn't the first char,
   *  it is a backslash, and
   *  it is not preceded by a delimiter
   */
  if (end > fileName && '\\' == *end
   && (! ('\\' == *(end-1) || ':' == *(end-1)))
     ) {
    end--; shave=1;
  }
#else
  /* non-Windows: implicitly, this is the Unix version */
  /* get the last delimiter */
  for (end = fileName + fileNameLen - 1;
       end >= fileName && '/' != *end;  end--);

  if (end > fileName && '/' == *end) {
    end--; shave=1;
  }
#endif  /* if defined(_WIN32) */

  for (s = fileName, t = dirName;  s <= end;  s++, t++)
    *t = *s;
  *t = '\0';

  if (shave) s++;
  for (t = fName;  s <= fileName + fileNameLen - 1;  s++, t++)
    *t = *s;
  *t = '\0';

  return dirName;
} /* extractFileDirFileName */

static soHandle_t
loadLib (const char *libName, char **errMsg)
{
  soHandle_t h;
#if defined(CIA_HP7)
  int flag = 0;
#endif

#if defined(_WIN32)
  h = LoadLibrary (libName);
  if (NULL == h) {
    *errMsg = winErr;
  }
  else {
    *errMsg = NULL;
  }
#elif defined(CIA_HP7)
  flag = BIND_IMMEDIATE | BIND_VERBOSE | DYNAMIC_PATH;
  h = shl_load (libName, flag, 0L);
  if (NULL == h) {
    *errMsg = strerror(errno);
  }
  else {
    *errMsg = NULL;
  }
#else
  h = dlopen (libName, RTLD_NOW);
  if (NULL == h) {
    *errMsg = dlerror();
  }
  else {
    *errMsg = NULL;
  }
#endif

  return h;
} /* loadLib */

static int
unLoadLib (soHandle_t hh)
{
  int rc;

#if defined(_WIN32)
  rc = FreeLibrary (hh);
  return ! rc;
#elif defined(CIA_HP7)
  rc = shl_unload (hh);
#else
  rc = dlclose (hh);
#endif
  return rc;
} /* unLoadLib */

static void *
loadSym (soHandle_t h, const char *sym, char **errMsg)
{
  void *s;
  const char *from;
  char *to;
  const char *tripSym;
  char lcbuf[257];
  char ucbuf[257];
  char ocbuf[257];
  size_t symLen;
  int trip;
#if defined(CIA_HP7)
  int rc;
#endif

  /* search in this order:
   *  1. lower
   *  2. original
   *  3. upper
   */

  symLen = 0;
  for (trip = 1;  trip <= 3;  trip++) {
    switch (trip) {
    case 1:                             /* lower */
      for (from = sym, to = lcbuf;  *from;  from++, to++) {
        *to = tolower(*from);
      }
      symLen = from - sym;
      lcbuf[symLen] = '\0';
      tripSym = lcbuf;
      break;
    case 2:                             /* original */
      tripSym = sym;
      break;
    case 3:                             /* upper */
      for (from = sym, to = ucbuf;  *from;  from++, to++) {
        *to = toupper(*from);
      }
      ucbuf[symLen] = '\0';
      tripSym = ucbuf;
      break;
    default:
      tripSym = sym;
    } /* end switch */
#if defined(_WIN32)
    s = GetProcAddress (h, tripSym);
    if (NULL != s) {
      return s;
    }
#elif defined(CIA_HP7)
    rc = shl_findsym (&h, tripSym, TYPE_UNDEFINED, &s);
    if (rc) {                     /* failure */
      *errMsg = strerror(errno);
    }
    else {                        /* success */
      *errMsg = NULL;
      return s;
    }
#else
    s = dlsym (h, tripSym);
    *errMsg = dlerror();
    if (NULL == *errMsg) {
      return s;
    }
#endif
  } /* end loop over symbol name variations */

  return NULL;
} /* loadSym */

/* TNAME = type name, ENAME = exported name */
#define LOADIT(TNAME,ENAME) symName = ENAME; TNAME = (TNAME##_t) loadSym (h, symName, &errMsg); if (NULL == TNAME) goto symMissing
#define LOADIT_ERR_OK(TNAME,ENAME) symName = ENAME; TNAME = (TNAME##_t) loadSym (h, symName, &errMsg)

#define BASENAME "liboptdclib"
#if defined(CIA_LEX) || defined(CIA_WEX) || defined(CIA_SOX)
# define SUFFIX "64"
#else
# define SUFFIX ""
#endif
#if defined(_WIN32)
# undef BASENAME
# define BASENAME "optdclib"
# define EXTENSION ".dll"
#elif defined(CIA_HP7)
# define EXTENSION ".sl"
#elif defined(CIA_DAR) || defined(CIA_DII)
# define EXTENSION ".dylib"
#else
# define EXTENSION ".so"
#endif

/* XLibraryLoad: return 0 on success, ~0 on failure */
static int
XLibraryLoad (const char *dllName, char *errBuf, int errBufSize)
{
  char *errMsg;
  char *symName;
  int rc, elen, cl;
  char *ebuf;

  if (isLoaded)
    return 0;
  h = loadLib (dllName, &errMsg);
  if (NULL == h) {
    if (NULL != errBuf) {
      elen = errBufSize;  ebuf = errBuf;
      rc = sprintf (ebuf, "%.*s", elen, "Could not load shared library ");
      elen -= rc;  ebuf+= rc;
      rc = sprintf (ebuf, "%.*s", elen, dllName);
      elen -= rc;  ebuf+= rc;
      rc = sprintf (ebuf, "%.*s", elen, ": ");
      elen -= rc;  ebuf+= rc;
      rc = sprintf (ebuf, "%.*s", elen, errMsg);
      elen -= rc;  ebuf+= rc;
      errBuf[errBufSize-1] = '\0';
    }
    return 1;
  }
  else {
     /* printf ("Loaded shared library %s successfully\n", dllName); */
    if (errBuf && errBufSize)
      errBuf[0] = '\0';
  }

  LOADIT(XCreate, "XCreate");
  LOADIT(XFree, "XFree");
  LOADIT(XCheck, "CXCheck");
  LOADIT(XAPIVersion, "CXAPIVersion");

  if (!XAPIVersion(2,errBuf,&cl))
    return 1;


  LOADIT_ERR_OK(optSetLoadPath, "CoptSetLoadPath");
  LOADIT_ERR_OK(optGetLoadPath, "CoptGetLoadPath");
#define CheckAndLoad(f,nargs,prefix) \
  if (!XCheck(#f,nargs,s,errBuf)) \
    f = &d_##f; \
  else { \
    LOADIT(f,prefix #f); \
  }
  {int s[]={3,11}; CheckAndLoad(optReadDefinition,1,"C"); }
  {int s[]={3,11}; CheckAndLoad(optReadParameterFile,1,"C"); }
  {int s[]={0,11}; CheckAndLoad(optReadFromStr,1,"C"); }
  {int s[]={3,11}; CheckAndLoad(optWriteParameterFile,1,"C"); }
  {int s[]={0}; CheckAndLoad(optClearMessages,0,""); }
  {int s[]={0,11}; CheckAndLoad(optAddMessage,1,"C"); }
  {int s[]={0,3,12,4}; CheckAndLoad(optGetMessage,3,"C"); }
  {int s[]={0}; CheckAndLoad(optResetAll,0,""); }
  {int s[]={0}; CheckAndLoad(optResetAllRecent,0,""); }
  {int s[]={0}; CheckAndLoad(optResetRecentChanges,0,""); }
  {int s[]={0,11}; CheckAndLoad(optShowHelp,1,"C"); }
  {int s[]={3,3}; CheckAndLoad(optResetNr,1,""); }
  {int s[]={3,11,4,4}; CheckAndLoad(optFindStr,3,"C"); }
  {int s[]={3,3,4,4,4,4,4,4}; CheckAndLoad(optGetInfoNr,7,""); }
  {int s[]={3,3,12,4,14,12}; CheckAndLoad(optGetValuesNr,5,"C"); }
  {int s[]={3,3,3,13,11}; CheckAndLoad(optSetValuesNr,4,"C"); }
  {int s[]={3,3,3,13,11}; CheckAndLoad(optSetValues2Nr,4,"C"); }
  {int s[]={0,12}; CheckAndLoad(optVersion,1,"C"); }
  {int s[]={0,12}; CheckAndLoad(optDefinitionFile,1,"C"); }
  {int s[]={3,3,12,12}; CheckAndLoad(optGetFromAnyStrList,3,"C"); }
  {int s[]={3,11,12}; CheckAndLoad(optGetFromListStr,2,"C"); }
  {int s[]={3,11}; CheckAndLoad(optListCountStr,1,"C"); }
  {int s[]={3,11,3,12}; CheckAndLoad(optReadFromListStr,3,"C"); }
  {int s[]={3}; CheckAndLoad(optSynonymCount,0,""); }
  {int s[]={3,3,12,12}; CheckAndLoad(optGetSynonym,3,"C"); }
  {int s[]={0,3}; CheckAndLoad(optEchoSet,1,""); }
  {int s[]={3,3}; CheckAndLoad(optEOLOnlySet,1,""); }
  {int s[]={0,3}; CheckAndLoad(optNoBoundsSet,1,""); }
  {int s[]={0,4,4}; CheckAndLoad(optErrorCount,2,""); }
  {int s[]={3,3,4,4,4}; CheckAndLoad(optGetBoundsInt,4,""); }
  {int s[]={3,3,14,14,14}; CheckAndLoad(optGetBoundsDbl,4,""); }
  {int s[]={3,3,12}; CheckAndLoad(optGetDefaultStr,2,"C"); }
  {int s[]={3,3,4}; CheckAndLoad(optGetIntNr,2,""); }
  {int s[]={3,3,4}; CheckAndLoad(optGetInt2Nr,2,""); }
  {int s[]={3,3,3}; CheckAndLoad(optSetIntNr,2,""); }
  {int s[]={3,3,3}; CheckAndLoad(optSetInt2Nr,2,""); }
  {int s[]={3,3,12}; CheckAndLoad(optGetStrNr,2,"C"); }
  {int s[]={3,3,12,4,4}; CheckAndLoad(optGetOptHelpNr,4,"C"); }
  {int s[]={3,3,3,4,12}; CheckAndLoad(optGetEnumHelp,4,"C"); }
  {int s[]={3,3,12,4}; CheckAndLoad(optGetEnumStrNr,3,"C"); }
  {int s[]={3,3,4}; CheckAndLoad(optGetEnumCount,2,""); }
  {int s[]={3,3,3,4,12}; CheckAndLoad(optGetEnumValue,4,"C"); }
  {int s[]={3,3,12}; CheckAndLoad(optGetStr2Nr,2,"C"); }
  {int s[]={3,3,11}; CheckAndLoad(optSetStrNr,2,"C"); }
  {int s[]={3,3,11}; CheckAndLoad(optSetStr2Nr,2,"C"); }
  {int s[]={3,3,14}; CheckAndLoad(optGetDblNr,2,""); }
  {int s[]={3,3,14}; CheckAndLoad(optGetDbl2Nr,2,""); }
  {int s[]={3,3,13}; CheckAndLoad(optSetDblNr,2,""); }
  {int s[]={3,3,13}; CheckAndLoad(optSetDbl2Nr,2,""); }
  {int s[]={3,11,12}; CheckAndLoad(optGetValStr,2,"C"); }
  {int s[]={3,11,12}; CheckAndLoad(optGetVal2Str,2,"C"); }
  {int s[]={3,3,12}; CheckAndLoad(optGetNameNr,2,"C"); }
  {int s[]={3,3,4}; CheckAndLoad(optGetDefinedNr,2,""); }
  {int s[]={3,3,12,12}; CheckAndLoad(optGetHelpNr,3,"C"); }
  {int s[]={3,3,12,4,4,12}; CheckAndLoad(optGetGroupNr,5,"C"); }
  {int s[]={3,3}; CheckAndLoad(optGetGroupGrpNr,1,""); }
  {int s[]={3,3}; CheckAndLoad(optGetOptGroupNr,1,""); }
  {int s[]={3,3,12,4,4,14}; CheckAndLoad(optGetDotOptNr,5,"C"); }
  {int s[]={3,3,3,12}; CheckAndLoad(optGetDotOptUel,3,"C"); }
  {int s[]={3,3,12,12,4,4,4}; CheckAndLoad(optGetIndicatorNr,6,"C"); }
  {int s[]={3,3,3,12}; CheckAndLoad(optGetEquIndicatorNr,3,"C"); }
  {int s[]={3,3,3,12}; CheckAndLoad(optGetVarIndicatorNr,3,"C"); }
  {int s[]={3,4}; CheckAndLoad(optIndicatorCount,1,""); }
  {int s[]={3,4}; CheckAndLoad(optDotOptCount,1,""); }
  {int s[]={3,3,3}; CheckAndLoad(optSetRefNr,2,""); }
  {int s[]={3,11,3}; CheckAndLoad(optSetRefNrStr,2,"C"); }
  {int s[]={3,3,3,12}; CheckAndLoad(optGetConstName,3,"C"); }
  {int s[]={3,3,12}; CheckAndLoad(optGetTypeName,2,"C"); }
  {int s[]={3,11}; CheckAndLoad(optLookUp,1,"C"); }
  {int s[]={0,10}; CheckAndLoad(optReadFromPChar,1,""); }
  {int s[]={3}; CheckAndLoad(optCount,0,""); }
  {int s[]={3}; CheckAndLoad(optMessageCount,0,""); }
  {int s[]={3}; CheckAndLoad(optGroupCount,0,""); }
  {int s[]={3}; CheckAndLoad(optRecentEnabled,0,""); }
  {int s[]={0,3}; CheckAndLoad(optRecentEnabledSet,1,""); }

 return 0;

 symMissing:
  if (errBuf && errBufSize>0) {
    elen = errBufSize;  ebuf = errBuf;
    rc = sprintf (ebuf, "%.*s", elen, "Could not load symbol '");
    elen -= rc;  ebuf+= rc;
    rc = sprintf (ebuf, "%.*s", elen, symName);
    elen -= rc;  ebuf+= rc;
    rc = sprintf (ebuf, "%.*s", elen, "': ");
    elen -= rc;  ebuf+= rc;
    rc = sprintf (ebuf, "%.*s", elen, errMsg);
    elen -= rc;  ebuf+= rc;
    errBuf[errBufSize-1] = '\0';
    /* printf ("%s\n", errBuf); */
    return 2;
  }

 return 0;

} /* XLibraryLoad */

static int
libloader(const char *dllPath, const char *dllName, char *msgBuf, int msgBufSize)
{

  char dllNameBuf[512];
  int myrc = 0;

  if (! isLoaded) {
    if (NULL != dllPath && '\0' != *dllPath) {
      strncpy(dllNameBuf, dllPath, sizeof(dllNameBuf)-1);
      dllNameBuf[sizeof(dllNameBuf)-2] = '\0';
#if defined(_WIN32)
      if ('\\' != dllNameBuf[strlen(dllNameBuf)])
        strcat(dllNameBuf,"\\");
#else
      if ('/' != dllNameBuf[strlen(dllNameBuf)])
        strcat(dllNameBuf,"/");
#endif
    }
    else {
      dllNameBuf[0] = '\0';
    }
    if (NULL != dllName && '\0' != *dllName) {
      strncat(dllNameBuf, dllName, sizeof(dllNameBuf)-strlen(dllNameBuf));
      dllNameBuf[sizeof(dllNameBuf)-1] = '\0';
    }
    else {
      strncat(dllNameBuf, BASENAME SUFFIX EXTENSION, sizeof(dllNameBuf)-strlen(dllNameBuf));
    }
    isLoaded = ! XLibraryLoad (dllNameBuf, msgBuf, msgBufSize);
    if (isLoaded) {
       if (NULL != optSetLoadPath && NULL != dllPath && '\0' != *dllPath) {
         optSetLoadPath(dllPath);
       }
       else {                            /* no setLoadPath call found */
         myrc |= 2;
       }
    }
    else {                              /* library load failed */
      myrc |= 1;
    }
  }
  return (myrc & 1) == 0;
}


/* optGetReady: return false on failure to load library, true on success */
int optGetReady (char *msgBuf, int msgBufSize)
{
  return libloader(NULL, NULL, msgBuf, msgBufSize);
} /* optGetReady */

/* optGetReadyD: return false on failure to load library, true on success */
int optGetReadyD (const char *dirName, char *msgBuf, int msgBufSize)
{
  return libloader(dirName, NULL, msgBuf, msgBufSize);
} /* optGetReadyD */

/* optGetReadyL: return false on failure to load library, true on success */
int optGetReadyL (const char *libName, char *msgBuf, int msgBufSize)
{
  char dirName[1024],fName[1024];
  extractFileDirFileName (libName, dirName, fName);
  return libloader(dirName, fName, msgBuf, msgBufSize);
} /* optGetReadyL */

/* optCreate: return false on failure to load library, true on success */
int optCreate (optHandle_t *popt, char *msgBuf, int msgBufSize)
{
  int optIsReady;

  optIsReady = optGetReady (msgBuf, msgBufSize);
  if (! optIsReady) {
    return 0;
  }
  assert(XCreate);
  XCreate(popt);
  objectCount++;
  return 1;                     /* return true on successful library load */
} /* optCreate */

/* optCreateD: return false on failure to load library, true on success */
int optCreateD (optHandle_t *popt, const char *dirName,
                char *msgBuf, int msgBufSize)
{
  int optIsReady;

  optIsReady = optGetReadyD (dirName, msgBuf, msgBufSize);
  if (! optIsReady) {
    return 0;
  }
  assert(XCreate);
  XCreate(popt);
  objectCount++;
  return 1;                     /* return true on successful library load */
} /* optCreateD */

/* optCreateL: return false on failure to load library, true on success */
int optCreateL (optHandle_t *popt, const char *libName,
                char *msgBuf, int msgBufSize)
{
  int optIsReady;

  optIsReady = optGetReadyL (libName, msgBuf, msgBufSize);
  if (! optIsReady) {
    return 0;
  }
  assert(XCreate);
  XCreate(popt);
  objectCount++;
  return 1;                     /* return true on successful library load */
} /* optCreateL */

int optFree   (optHandle_t *popt)
{
  assert(XFree);
  XFree(popt); popt = NULL;
  objectCount--;
  return 1;
} /* optFree */

int optLibraryLoaded(void)
{
  return isLoaded;
} /* optLibraryLoaded */

int optLibraryUnload(void)
{
  if (objectCount > 0)
    return 0;
  isLoaded = 0;
  (void) unLoadLib(h);
  return 1;
} /* optLibraryUnload */

int optGetScreenIndicator(void)
{
  return ScreenIndicator;
}

void optSetScreenIndicator(int scrind)
{
  ScreenIndicator = scrind ? 1 : 0;
}

int optGetExceptionIndicator(void)
{
   return ExceptionIndicator;
}

void optSetExceptionIndicator(int excind)
{
  ExceptionIndicator = excind ? 1 : 0;
}

int optGetExitIndicator(void)
{
  return ExitIndicator;
}

void optSetExitIndicator(int extind)
{
  ExitIndicator = extind ? 1 : 0;
}

optErrorCallback_t optGetErrorCallback(void)
{
  return ErrorCallBack;
}

void optSetErrorCallback(optErrorCallback_t func)
{
  ErrorCallBack = func;
}

void optErrorHandling(const char *msg)
{
  optAPIErrorCount++;
  if (ScreenIndicator) printf("%s\n", msg);
  if (ErrorCallBack)
     if (ErrorCallBack(optAPIErrorCount, msg)) exit(1);
  assert(!ExceptionIndicator);
  if (ExitIndicator) exit(1);
}

